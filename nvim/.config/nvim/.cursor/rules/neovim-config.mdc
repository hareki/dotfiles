---
description: Neovim config architecture and conventions for lazy.nvim setup
globs: **/*.lua
alwaysApply: false
---

# Neovim Config Architecture

## Architecture

**lazy.nvim** config with strict one-plugin-per-file under `lua/plugins/{ai,coding,editor,formatting,lsp,treesitter,ui}/`.

### Central Modules (`lua/configs/`)

| Module        | Purpose                                                                          |
| ------------- | -------------------------------------------------------------------------------- |
| `size.lua`    | Size presets: `popup` (`sm`/`md`/`lg`/`vertical_lg`/`full`), `side_preview`, `side_panel`, `inline_popup` |
| `icons.lua`   | All icons (diagnostics, git, file status, LSP kinds, explorer)                   |
| `globals.lua` | `_G.Notifier`, `_G.Defer`, `_G.Catppuccin` lazy proxies                          |
| `picker.lua`  | Shared picker UI constants (`prompt_prefix`, `preview_title`)                    |

### Utils (`lua/utils/`)

| Module             | Key Exports                                                              |
| ------------------ | ------------------------------------------------------------------------ |
| `ui.lua`           | `popup_config(size)`, `catppuccin(fn)`, `get_palette()`, `telescope_layout(size)`, `computed_size(size)` |
| `common.lua`       | `noautocmd(fn)`, `focus_win(win)`, `is_float_win()`, `list_extend(...)`  |
| `notifier.lua`     | Rich notifications with highlight support                                |
| `lazy-require.lua` | `Defer.on_index()`, `Defer.on_exported_call()`                           |

## Plugin Patterns

### Complex Plugin Structure

For plugins requiring state management or extensive customization:

```
nvim-tree/
  init.lua   -- Returns table: [1] catppuccin highlights, [2+] plugin specs
  utils.lua  -- M.state = {} table + helper functions
```

Example `init.lua` structure:

```lua
return {
  Catppuccin(function(palette, sub_palette)
    return { MyHighlight = { fg = palette.blue, bg = palette.base } }
  end),
  { 'author/plugin-dependency', opts = {...} },
  { 'author/main-plugin', opts = function() ... end },
}
```

### Catppuccin Highlight Registration

Use global `Catppuccin` (from `globals.lua`) when plugin needs custom highlights. Place it first in returned table:

```lua
return {
  Catppuccin(function(palette, sub_palette)
    return {
      MyHighlight = { fg = palette.blue, bg = palette.base },
      MyOtherHighlight = { fg = sub_palette.yellow }, -- sub_palette = latte flavor
    }
  end),
  { 'plugin/name', opts = {...} },
}
```

### Popup Sizing

Use `popup_config(size)` from `utils.ui` — never hardcode dimensions:

```lua
local ui = require('utils.ui')
local size = ui.popup_config('lg')
-- Returns: { width, height, col, row }
```

For side panels or previews, access size configs directly:

```lua
local size_configs = require('configs.size')
local ui = require('utils.ui')
local panel_width = ui.computed_size(size_configs.side_panel.md)
```

### State Management Pattern

Complex plugins use `M.state = {}` in their `utils.lua`:

```lua
---@class MyPlugin.Utils
local M = {}

---@class MyPlugin.State
---@field position 'float' | 'side'
---@field preview_on_focus boolean

---@type MyPlugin.State
M.state = {
  position = 'float',
  preview_on_focus = false,
}
```

## Conventions

### Plugin Spec Key Order

**lazy.nvim** plugin specs must follow this exact key order:

1. `plugin name` (string, e.g., `'author/repo'`)
2. `enabled` → `cond` → `name` → `branch` → `version` → `build` → `main`
3. `lazy` → `priority`
4. `cmd` → `event` → `ft`
5. `dependencies`
6. `keys` → `init` → `opts` → `opts_extend` → `config`

**Keymap definitions** within `keys` follow this order:

```lua
{ lhs, rhs, mode = '...', desc = '...', expr = true, silent = true }
```

Order: **lhs** → **rhs** → **mode** → **desc** → **expr** → **silent**

### Keymaps

- **Always** include `desc` in CMOS 18 title case: "Find Files", "Go to Definition"
- `<A-key>` for Alt bindings; `<leader>` for command groups
- `<A-s>` = format + save; `<leader>F` = format only

### Notifications

Use global `Notifier` (auto lazy-loaded via `globals.lua`):

```lua
Notifier.info('Message')
Notifier.warn('Warning', { title = 'Title' })
```

### Module Returns

- Always return tables (no global mutation)
- Use LuaLS `---@class` annotations for public module APIs

## LSP Setup

Per-server configs in `lua/plugins/lsp/nvim-lspconfig/lsp/{server}.lua`. Mason handles tool installation via `lua/plugins/lsp/mason.nvim.lua`.

## Formatting

Single async pipeline in `utils/formatters/async_style_enforcer.lua`:

- Runs conform.nvim → linters sequentially
- Buffer locks prevent concurrent operations
- Call: `local enforcer = require('utils.formatters.async_style_enforcer'); enforcer.run()`

## Snacks Picker

Custom pickers live in `lua/plugins/ui/snacks/pickers/`. Each exports `M.show(user_opts)`:

```lua
-- pickers/harpoon.lua
local M = {}

M.show = function(user_opts)
  local items = build_items()
  if vim.tbl_isempty(items) then
    Notifier.info('Harpoon list is empty')
    return
  end

  local opts = vim.tbl_deep_extend('force', {
    title = 'Harpoon',
    items = items,
    source = 'harpoon',
    format = custom_format,
    transform = custom_transform,
  }, user_opts or {})

  -- Define custom actions
  opts.actions = opts.actions or {}
  opts.actions.remove_item = function(picker) ... end

  return Snacks.picker(opts)
end

return M
```

**Existing pickers**: `harpoon`

### Shared Utilities (`snacks/utils/`)

| Module            | Key Exports                                                    |
| ----------------- | -------------------------------------------------------------- |
| `formatters.lua`  | `keymap_format`, `buffer_format`, `buffer_select_format`       |
| `transformers.lua`| `files_transform`, `keymap_transform`, `buffer_select_transform` |
| `sorters.lua`     | Custom sorting functions                                       |
| `cache.lua`       | Query result caching for transformers                          |

**Invocation pattern** (from keymaps in `snacks/init.lua`):

```lua
local harpoon_picker = require('plugins.ui.snacks.pickers.harpoon')
harpoon_picker.show({ preview = 'main' })
```

## Forks (author = `hareki`)

15+ minimal-diff forks enable unified UX:

- **Tab** = toggle focus (list↔preview, float↔main)
- **`<C-t>`** = toggle side-panel mode
- Updated via [wei/pull](https://github.com/wei/pull); features toggleable

## Code Style

- stylua: 100-char lines, 2-space indent
- Lazy-load via `event = 'VeryLazy'` or keymap triggers
- LuaLS `---@class` / `---@param` / `---@return` annotations for public APIs
- Import icons from `configs/icons.lua` — never hardcode icon strings
- Use `Notifier` global for notifications (lazy-loaded via `globals.lua`)
- Use `Catppuccin` global for highlight registration in plugin specs

**Module Imports**: `require()` should only be used for importing modules, never for accessing properties or methods on the same line. Always assign to a local variable first:

```lua
-- Bad
require('plugins.ui.lualine.utils').refresh_statusline()

-- Good
local lualine_utils = require('plugins.ui.lualine.utils')
lualine_utils.refresh_statusline()
```

**Type Aliases**: Define type aliases for state fields:

```lua
---@alias MyPlugin.Position 'side' | 'float'

---@class MyPlugin.State
---@field position MyPlugin.Position
```
